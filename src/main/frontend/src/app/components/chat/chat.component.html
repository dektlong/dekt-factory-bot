<div class="chat-layout">
  <!-- Config Panel (Left) -->
  <app-config-panel
    [collapsed]="configPanelCollapsed()"
    (collapseToggle)="toggleConfigPanel()"
  />

  <div class="chat-container">
    <!-- Header with session controls -->
    <div class="chat-header">
      <div class="header-content">
        <div class="session-info">
          <mat-icon svgIcon="goose" class="session-icon"></mat-icon>
          <span class="session-text">
            @if (sessionId()) {
              <strong>Active Conversation</strong>
              <span class="session-id">Session: {{ sessionId()?.substring(0, 8) }}...</span>
            } @else {
              <strong>No Active Session</strong>
            }
          </span>
          @if (gooseAvailable) {
            <span class="provider-badge" [class.genai-service]="isGenaiService">
              <mat-icon class="provider-icon">{{ isGenaiService ? 'cloud' : 'smart_toy' }}</mat-icon>
              {{ gooseProvider }} Â· {{ gooseModel }}
              @if (isGenaiService) {
                <span class="source-badge">GenAI</span>
              }
            </span>
          }
        </div>
        <div class="session-actions">
          <button
            mat-icon-button
            (click)="toggleConfigPanel()"
            [matTooltip]="configPanelCollapsed() ? 'Show config panel' : 'Hide config panel'"
          >
            <mat-icon>{{ configPanelCollapsed() ? 'settings' : 'settings' }}</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="toggleActivityPanel()"
            [matTooltip]="activityPanelCollapsed() ? 'Show activity panel' : 'Hide activity panel'"
          >
            <mat-icon>{{ activityPanelCollapsed() ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="startNewConversation()"
            [disabled]="isCreatingSession() || !gooseAvailable"
            matTooltip="Start new conversation"
            color="primary"
          >
            <mat-icon>add_circle</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="endConversation()"
            [disabled]="!sessionId() || isStreaming()"
            matTooltip="End current conversation"
            color="warn"
          >
            <mat-icon>stop_circle</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <div class="messages-container" #messagesContainer>
      @if (messages().length === 0) {
        <div class="welcome-message">
          <mat-icon svgIcon="goose" class="welcome-icon"></mat-icon>
          <h2>Tanzu Factory</h2>
          @if (gooseAvailable) {
            <p class="status-text">Goose v{{ gooseVersion }} is ready</p>
            <p class="provider-info">
              Provider: {{ gooseProvider }} | Model: {{ gooseModel }}
              @if (isGenaiService) {
                <span class="source-indicator">(via GenAI Service)</span>
              }
            </p>
            @if (sessionId()) {
              <p class="status-text info">Conversation session active - Goose will remember your conversation context</p>
            } @else if (isCreatingSession()) {
              <p class="status-text info">Starting new conversation...</p>
            }
          } @else {
            <p class="status-text error">{{ gooseMessage || 'Goose CLI is not available' }}</p>
          }
        </div>
      }

      @for (message of messages(); track message.timestamp) {
        <div class="message" [class.user-message]="message.role === 'user'"
             [class.assistant-message]="message.role === 'assistant'">
          <mat-card class="message-card" appearance="outlined">
            <mat-card-content>
              <div class="message-header">
                @if (message.role === 'user') {
                  <mat-icon class="message-icon">person</mat-icon>
                } @else {
                  <mat-icon svgIcon="goose" class="message-icon"></mat-icon>
                }
                <span class="message-role">{{ message.role === 'user' ? 'You' : 'Goose' }}</span>
                @if (message.streaming) {
                  <mat-spinner diameter="16" class="streaming-indicator"></mat-spinner>
                }
              </div>
              <div class="message-content">
                <markdown [data]="message.content"></markdown>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      }
    </div>

    <div class="input-container">
      <div class="input-row">
        <mat-form-field appearance="outline" class="message-input">
          <mat-label>Type your message...</mat-label>
          <textarea
            matInput
            [value]="userInput()"
            (input)="onInputChange($event)"
            (keypress)="onKeyPress($event)"
            [disabled]="isStreaming() || !gooseAvailable || !sessionId()"
            rows="3"
            placeholder="Ask Goose anything..."
          ></textarea>
        </mat-form-field>
        <button
          mat-icon-button
          (click)="triggerPdfImport()"
          [disabled]="isStreaming() || isImportingPdf()"
          matTooltip="Import PDF document"
          class="attach-pdf-btn"
        >
          <mat-icon>picture_as_pdf</mat-icon>
        </button>
      </div>
      @if (isImportingPdf()) {
        <mat-progress-bar mode="indeterminate" class="pdf-progress"></mat-progress-bar>
      }
      @if (importedPdf(); as pdf) {
        <div class="imported-pdf-chip" [class.indexed]="documentIngested()">
          <mat-icon class="pdf-chip-icon">{{ documentIngested() ? 'search' : 'description' }}</mat-icon>
          <span class="pdf-chip-label">
            {{ pdf.filename }} ({{ pdf.pageCount }} page(s))
            @if (documentIngested()) {
              <span class="indexed-badge">indexed</span>
            }
          </span>
          <button mat-icon-button (click)="clearImportedPdf()" matTooltip="Remove document">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      }
      <button
        mat-fab
        extended
        color="primary"
        (click)="sendMessage()"
        [disabled]="(!userInput().trim() && !importedPdf()) || isStreaming() || !gooseAvailable || !sessionId()"
        class="send-button"
      >
        @if (isStreaming()) {
          <mat-spinner diameter="24"></mat-spinner>
        } @else {
          <mat-icon>send</mat-icon>
        }
        {{ isStreaming() ? 'Sending...' : 'Send' }}
      </button>
    </div>
  </div>

  <!-- Activity Panel -->
  <app-activity-panel
    [activities]="activities()"
    [todos]="todos()"
    [collapsed]="activityPanelCollapsed()"
    (collapseToggle)="toggleActivityPanel()"
  />
</div>
